/*! (c) Philipp KÃ¶nig under GPL-3.0 */
(()=>{"use strict";window.ext=function(e){let i=null,n={},t=!1;this.initialized=null,this.run=(()=>{d(),o(),this.initialized=+new Date});let o=()=>{let i=["pxTolerance","showIndicator","closeTab","openAction"];chrome.storage.sync.get(i,n=>{i.forEach(i=>{void 0!==n[i]&&(e.config[i]=n[i])}),matchMedia("(min-resolution: 1.25dppx)").matches&&Object.keys(e.config.pxTolerance).forEach(i=>{e.config.pxTolerance[i]++}),a(),l(),u()})},s=()=>{let i=0!==window.screenX||0!==window.screenY||window.screen.availWidth!==window.innerWidth;return+e.config.pxTolerance[i?"windowed":"maximized"]},d=()=>new Promise(e=>{i&&i.disconnect(),(i=chrome.runtime.connect({name:"background"})).onMessage.addListener(e=>{n[e.uid]&&(n[e.uid](e.result),delete n[e.uid])}),e()}),c=()=>{let t=!0;window.onbeforeunload=window.onpopstate=(()=>{t=!1}),window.history.back(),setTimeout(()=>{e.config.closeTab&&t&&((e,t={})=>new Promise(o=>{if(i){t.type=e,t.uid=e+"_"+JSON.stringify(t)+"_"+ +new Date+Math.random().toString(36).substr(2,12),n[t.uid]=(e=>{o(e)});try{i.postMessage(t)}catch(e){}}}))("closeTab")},200)},a=()=>{document.addEventListener(e.config.openAction,i=>{i.isTrusted&&("mousedown"!==e.config.openAction||0===i.button)&&r(i.pageX,i.pageY)&&(i.stopPropagation(),i.preventDefault(),c())}),document.addEventListener("DOMContentLoaded",()=>{l()}),chrome.extension.onMessage.addListener(e=>{e&&e.action&&(null===e.reinitialized||this.initialized>e.reinitialized)&&"navigateBack"===e.action&&c()})},l=()=>{if(document&&document.body&&null===document.querySelector("#"+e.ids.indicator)){let i=document.createElement("div");i.id=e.ids.indicator,i.innerHTML="<div><span></span></div>",document.body.appendChild(i),i.style.width=s()+"px",e.config.showIndicator&&(i.classList.add(e.classes.visible),document.addEventListener("mousemove",n=>{n.isTrusted&&r(n.pageX,n.pageY)?i.classList.add(e.classes.hover):(void 0===n.pageX||n.pageX>=e.config.indicatorWidth)&&i.classList.remove(e.classes.hover)}),document.addEventListener("visibilitychange",()=>{document.hidden&&i.classList.remove(e.classes.hover)}),window.addEventListener("resize",()=>{i.style.width=s()+"px"},{passive:!0}))}},r=(i,n)=>{let o=!1;if(null!=i&&(i>0||n>0||t)){t=!0;let n=document.querySelector("#"+e.ids.indicator);if(n){let t=s();n.classList.contains(e.classes.visible)&&n.classList.contains(e.classes.hover)&&e.config.indicatorWidth>t&&(t=e.config.indicatorWidth),o=i<t}}return o},u=()=>{document.dispatchEvent(new CustomEvent(e.events.loaded,{detail:{pxTolerance:s(),showIndicator:e.config.showIndicator},bubbles:!0,cancelable:!1}))}}})(),(()=>{"use strict";new window.ext({ids:{indicator:"blockbyte-lsb-indicator"},classes:{visible:"blockbyte-lsb-visible",hover:"blockbyte-lsb-hover"},events:{loaded:"blockbyte-lsb-loaded"},config:{pxTolerance:{windowed:20,maximized:1},openAction:"mousedown",showIndicator:!0,closeTab:!1,indicatorWidth:40}}).run()})();