/*! (c) Philipp KÃ¶nig under GPL-3.0 */
(()=>{"use strict";window.ext=function(e){let i=null,n={},t=!1,o=["pxTolerance","showIndicator","closeTab","navigateForward","openAction"];this.initialized=null,this.run=(()=>{a(),s(),this.initialized=+new Date});let s=async()=>{chrome.storage.sync.get(o,i=>{o.forEach(n=>{void 0!==i[n]&&(e.config[n]=i[n])}),matchMedia("(min-resolution: 1.25dppx)").matches&&Object.keys(e.config.pxTolerance).forEach(i=>{e.config.pxTolerance[i]++}),r(),l(),w()})},d=()=>{let i=0!==window.screenX||0!==window.screenY||window.screen.availWidth!==window.innerWidth;return+e.config.pxTolerance[i?"windowed":"maximized"]},a=async()=>{i&&i.disconnect(),(i=chrome.runtime.connect({name:"background"})).onMessage.addListener(e=>{n[e.uid]&&(n[e.uid](e.result),delete n[e.uid])})},c=()=>{let t=!0;window.onbeforeunload=window.onpopstate=(()=>{t=!1}),window.history.back(),setTimeout(()=>{e.config.closeTab&&t&&((e,t={})=>new Promise(o=>{if(i){t.type=e,t.uid=e+"_"+JSON.stringify(t)+"_"+ +new Date+Math.random().toString(36).substr(2,12),n[t.uid]=(e=>{o(e)});try{i.postMessage(t)}catch(e){}}}))("closeTab")},200)},r=()=>{["mousedown","contextmenu"].forEach(i=>{document.addEventListener(i,n=>{n.isTrusted&&("mousedown"!==i||0===n.button)&&u(n.pageX,n.pageY)&&(n.stopPropagation(),n.preventDefault(),i===e.config.openAction?c():e.config.navigateForward&&window.history.forward())})}),document.addEventListener("DOMContentLoaded",()=>{l()}),chrome.extension.onMessage.addListener(e=>{e&&e.action&&(null===e.reinitialized||this.initialized>e.reinitialized)&&"navigateBack"===e.action&&c()})},l=()=>{if(document&&document.body&&null===document.querySelector("#"+e.ids.indicator)){let i=document.createElement("div");i.id=e.ids.indicator,i.innerHTML="<div><span></span></div>",document.body.appendChild(i),i.style.width=d()+"px",e.config.showIndicator&&(i.classList.add(e.classes.visible),document.addEventListener("mousemove",n=>{n.isTrusted&&u(n.pageX,n.pageY)?i.classList.add(e.classes.hover):(void 0===n.pageX||n.pageX>=e.config.indicatorWidth)&&i.classList.remove(e.classes.hover)}),document.addEventListener("visibilitychange",()=>{document.hidden&&i.classList.remove(e.classes.hover)}),window.addEventListener("resize",()=>{i.style.width=d()+"px"},{passive:!0}))}},u=(i,n)=>{let o=!1;if(null!=i&&(i>0||n>0||t)){t=!0;let n=document.querySelector("#"+e.ids.indicator);if(n){let t=d();n.classList.contains(e.classes.visible)&&n.classList.contains(e.classes.hover)&&e.config.indicatorWidth>t&&(t=e.config.indicatorWidth),o=i<t}}return o},w=()=>{document.dispatchEvent(new CustomEvent(e.events.loaded,{detail:{pxTolerance:d(),showIndicator:e.config.showIndicator},bubbles:!0,cancelable:!1}))}}})(),(()=>{"use strict";new window.ext({ids:{indicator:"blockbyte-lsb-indicator"},classes:{visible:"blockbyte-lsb-visible",hover:"blockbyte-lsb-hover"},events:{loaded:"blockbyte-lsb-loaded"},config:{pxTolerance:{windowed:20,maximized:1},openAction:"mousedown",showIndicator:!0,closeTab:!1,navigateForward:!1,indicatorWidth:40}}).run()})();